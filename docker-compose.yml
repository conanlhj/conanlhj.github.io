version: '3.8'

services:
  blog-preview:
    # DevContainer와 동일한 마이크로소프트 공식 이미지 사용
    image: mcr.microsoft.com/devcontainers/jekyll:2-bullseye

    container_name: chirpy-server

    # 컨테이너 시작 시 실행할 명령어:
    # 1. post-create.sh가 있으면 실행 (Chirpy 초기화)
    # 2. 필요한 젬(Gem) 설치
    # 3. 서버 실행 (0.0.0.0으로 열어야 외부 접속 가능)
    command: >
      /bin/sh -c "
      if [ -f .devcontainer/post-create.sh ]; then bash .devcontainer/post-create.sh; fi &&
      bundle install && 
      bundle exec jekyll serve --host 0.0.0.0 --port 4000 --livereload --force_polling"

    ports:
      - "4000:4000"   # 블로그 접속
      - "35729:35729" # 실시간 갱신(LiveReload)

    volumes:
      - .:/workspaces/blog # 현재 폴더를 컨테이너 내부와 연결

    working_dir: /workspaces/blog

    environment:
      - JEKYLL_ENV=development

    restart: always # 서버 재부팅해도 자동 실행
